<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìµœì í™”ëœ ë°°ì¹˜ ì „ì†¡ ì˜ˆì œ</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 0 20px; }
    button { margin: 10px 5px; padding: 10px 20px; cursor: pointer; }
    .immediate { background: #ff5722; color: white; border: none; }
    .batched { background: #4caf50; color: white; border: none; }
    .info { background: #f5f5f5; padding: 15px; margin: 20px 0; border-left: 4px solid #2196f3; }
    .log { background: #263238; color: #aed581; padding: 15px; margin: 20px 0; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>ğŸš€ ìµœì í™”ëœ ë°°ì¹˜ ì „ì†¡ ì˜ˆì œ</h1>
  
  <div class="info">
    <h3>ì„¤ì • ì „ëµ</h3>
    <ul>
      <li><strong>enableAutoFlush: false</strong> â†’ 10ì´ˆë§ˆë‹¤ ìë™ ì „ì†¡ âŒ</li>
      <li><strong>flushOnRouteChange: true</strong> â†’ SPA í˜ì´ì§€ ì´ë™ ì‹œ ìë™ ì „ì†¡ âœ…</li>
      <li><strong>add_to_cart, purchase ë“±</strong> â†’ ì¦‰ì‹œ ì „ì†¡ âœ…</li>
      <li><strong>SKU ì„ íƒ, ì˜µì…˜ ë³€ê²½</strong> â†’ íì— ëˆ„ì  âœ…</li>
      <li><strong>í˜ì´ì§€ ì´ë™(pushState/popstate)</strong> â†’ ìë™ flush âœ…</li>
      <li><strong>í˜ì´ì§€ ì´íƒˆ(pagehide/beforeunload)</strong> â†’ sendBeaconìœ¼ë¡œ ì „ì†¡ âœ…</li>
    </ul>
  </div>

  <h2>í…ŒìŠ¤íŠ¸ ë²„íŠ¼</h2>
  
  <div>
    <h3>ì¦‰ì‹œ ì „ì†¡ ì´ë²¤íŠ¸ (immediate)</h3>
    <button class="immediate" onclick="addToCart()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€</button>
    <button class="immediate" onclick="purchase()">ğŸ’³ êµ¬ë§¤ ì™„ë£Œ</button>
    <button class="immediate" onclick="purchaseCard()">ğŸ’³ ì¹´ë“œ ê²°ì œ ì™„ë£Œ</button>
    <button class="immediate" onclick="beginCheckout()">ğŸ“¦ ì²´í¬ì•„ì›ƒ ì‹œì‘</button>
  </div>

  <div>
    <h3>ë°°ì¹˜ ëˆ„ì  ì´ë²¤íŠ¸ (batched)</h3>
    <button class="batched" onclick="selectOption()">ğŸ¨ ì˜µì…˜ ì„ íƒ (ìƒ‰ìƒ)</button>
    <button class="batched" onclick="selectSize()">ğŸ“ ì˜µì…˜ ì„ íƒ (ì‚¬ì´ì¦ˆ)</button>
    <button class="batched" onclick="viewProductDetail()">ğŸ‘ï¸ ìƒí’ˆ ìƒì„¸ ì¡°íšŒ</button>
    <button class="batched" onclick="scrollProduct()">ğŸ“œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸</button>
  </div>

  <div>
    <h3>ìˆ˜ë™ ì œì–´</h3>
    <button onclick="manualFlush()">ğŸš€ ìˆ˜ë™ Flush (í ë¹„ìš°ê¸°)</button>
    <button onclick="checkQueue()">ğŸ“Š í ìƒíƒœ í™•ì¸</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
  </div>

  <div>
    <h3>ì¸ì¦ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ)</h3>
    <button onclick="login()">ğŸ” ë¡œê·¸ì¸ (identify)</button>
    <button onclick="logout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ (logout)</button>
  </div>

  <div>
    <h3>í˜ì´ì§€ ì´ë™ í…ŒìŠ¤íŠ¸</h3>
    <button onclick="simulateNavigation()">ğŸ”„ í˜ì´ì§€ ì´ë™ ì‹œë®¬ë ˆì´ì…˜</button>
    <button onclick="window.location.href='https://example.com'">ğŸŒ ì‹¤ì œ ì´íƒˆ (ëˆ„ì ëœ ì´ë²¤íŠ¸ ì „ì†¡ë¨)</button>
  </div>

  <div class="log" id="log"></div>

  <script src="../dist/browser/recommend-sdk.js"></script>
  <script>
    console.log('%c[DEBUG] SDK Version:', 'color: blue; font-weight: bold;', RecommendSDK.version);
  
    // ë¡œê·¸ ì¶œë ¥ í—¬í¼
    function log(type, message, data) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const color = type === 'immediate' ? '#ff5722' : type === 'batched' ? '#4caf50' : '#2196f3';
      logEl.innerHTML += `<div style="color: ${color}">[${time}] ${type.toUpperCase()}: ${message}</div>`;
      if (data) {
        logEl.innerHTML += `<div style="color: #78909c; margin-left: 20px;">${JSON.stringify(data, null, 2)}</div>`;
      }
      logEl.scrollTop = logEl.scrollHeight;
    }

    // demo state
    const state = {
      sku: 'SKU-123',
      selectedOptions: [],
      userId: null,
    };

    // 1) SDK ì´ˆê¸°í™”
    RecommendSDK.init({
      env: 'development',
      enableLogging: true,
      enableAutoFlush: false, // ğŸ”¥ 10ì´ˆë§ˆë‹¤ ìë™ ì „ì†¡ ë¹„í™œì„±í™”
      autoRouteTracking: true, // ğŸ”¥ history API í›… í™œì„±í™” (pushState/popstate ê°ì§€)
      flushOnRouteChange: true, // ğŸš€ SPA í˜ì´ì§€ ì´ë™ ì‹œ ìë™ flush (ê¸°ë³¸ê°’: true)
      autoPageView: true, // ğŸš€ í˜ì´ì§€ ì´ë™ ì‹œ page_view ìë™ ì „ì†¡ (ê¸°ë³¸ê°’: true)
      batchSize: 10, // 10ê°œ ìŒ“ì´ë©´ ìë™ ì „ì†¡
      
      // ì¦‰ì‹œ ì „ì†¡í•  ì´ë²¤íŠ¸ íƒ€ì… (ê¸°ë³¸ê°’ + ì»¤ìŠ¤í…€ ì¶”ê°€ ê°€ëŠ¥)
      immediateEventTypes: {
        action: true,
        add_to_cart: true,
        remove_from_cart: true,
        purchase: true,
        begin_checkout: true,
        add_payment_info: true,
        add_shipping_info: true,
        // í•„ìš”ì‹œ ì¶”ê°€:
        // subscribe: true,
        // cancel_subscription: true,
      }
    });

    log('system', 'SDK ì´ˆê¸°í™” ì™„ë£Œ', {
      config: {
        enableAutoFlush: RecommendSDK.config.enableAutoFlush,
        autoRouteTracking: RecommendSDK.config.autoRouteTracking,
        flushOnRouteChange: RecommendSDK.config.flushOnRouteChange,
        autoPageView: RecommendSDK.config.autoPageView,
        batchSize: RecommendSDK.config.batchSize,
        immediateEventTypes: Object.keys(RecommendSDK.config.immediateEventTypes),
      },
      note: 'history.pushState/popstate ê°ì§€ í™œì„±í™”ë¨'
    });

    // 2) ë¡œê·¸ì¸/ìœ ì € ì¸ì¦ ê´€ë ¨
    function login() {
      state.userId = 'user_' + Math.random().toString(36).slice(2, 8);
      RecommendSDK.identify({ userId: state.userId });
      log('system', 'ë¡œê·¸ì¸(identify) ì™„ë£Œ', { userId: state.userId });
    }

    // 3) ë¡œê·¸ì•„ì›ƒ/ì¸ì¦ í•´ì œ
    function logout() {
      const prev = state.userId;
      RecommendSDK.logout();
      state.userId = null;
      log('system', 'ë¡œê·¸ì•„ì›ƒ(logout) ì™„ë£Œ', { prevUserId: prev });
    }

    // ì¦‰ì‹œ ì „ì†¡ ì´ë²¤íŠ¸ë“¤
    function addToCart() {
      const sku = state.sku;
      RecommendSDK.trackEvent('add_to_cart', {
        sku: sku,
        quantity: 1,
        price: 29900,
        options: state.selectedOptions.slice(),
      });
      log('immediate', 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ (ì¦‰ì‹œ ì „ì†¡)', { sku });
    }

    function purchase() {
      RecommendSDK.trackEvent('purchase', {
        orderId: 'ORD-' + Date.now(),
        paymentMethod: 'unknown',
        amount: 89700,
        items: [
          { sku: state.sku, quantity: 1, options: state.selectedOptions.slice() }
        ]
      });
      log('immediate', 'êµ¬ë§¤ ì™„ë£Œ (ì¦‰ì‹œ ì „ì†¡)');
    }

    // 4) êµ¬ë§¤ì‹œ, ì¹´ë“œ êµ¬ì… ì´ë²¤íŠ¸ ì˜ˆì œ
    function purchaseCard() {
      RecommendSDK.trackEvent('purchase', {
        orderId: 'ORD-' + Date.now(),
        paymentMethod: 'card',
        amount: 89700,
        items: [{ sku: state.sku, quantity: 1, options: state.selectedOptions.slice() }],
        card: { issuer: 'demo', installmentMonths: 0 }
      });
      log('immediate', 'ì¹´ë“œ ê²°ì œ ì™„ë£Œ (ì¦‰ì‹œ ì „ì†¡)');
    }

    function beginCheckout() {
      RecommendSDK.trackEvent('begin_checkout', {
        cartValue: 59800,
        itemCount: 3
      });
      log('immediate', 'ì²´í¬ì•„ì›ƒ ì‹œì‘ (ì¦‰ì‹œ ì „ì†¡)');
    }

    // ë°°ì¹˜ ëˆ„ì  ì´ë²¤íŠ¸ë“¤
    function selectOption() {
      const color = ['red', 'blue', 'green'][Math.floor(Math.random() * 3)];
      // 5) sku ê°™ì€ option payload: ì„ íƒí•  ë•Œë§ˆë‹¤ ëˆ„ì 
      state.selectedOptions.push({ name: 'color', value: color });
      RecommendSDK.trackEvent('select_option', {
        optionType: 'color',
        optionValue: color,
        sku: state.sku,
        selectedOptions: state.selectedOptions.slice(),
      });
      log('batched', `ì˜µì…˜ ì„ íƒ: ${color} (íì— ì¶”ê°€ë¨)`, { queueSize: RecommendSDK._queue.length });
    }

    function selectSize() {
      const size = ['S', 'M', 'L', 'XL'][Math.floor(Math.random() * 4)];
      state.selectedOptions.push({ name: 'size', value: size });
      RecommendSDK.trackEvent('select_option', {
        optionType: 'size',
        optionValue: size,
        sku: state.sku,
        selectedOptions: state.selectedOptions.slice(),
      });
      log('batched', `ì‚¬ì´ì¦ˆ ì„ íƒ: ${size} (íì— ì¶”ê°€ë¨)`, { queueSize: RecommendSDK._queue.length });
    }

    function viewProductDetail() {
      RecommendSDK.trackEvent('view_item', {
        sku: 'SKU-' + Math.floor(Math.random() * 1000),
        category: 'electronics'
      });
      log('batched', 'ìƒí’ˆ ìƒì„¸ ì¡°íšŒ (íì— ì¶”ê°€ë¨)', { queueSize: RecommendSDK._queue.length });
    }

    function scrollProduct() {
      RecommendSDK.trackEvent('scroll', {
        scrollDepth: Math.floor(Math.random() * 100),
        page: 'product_detail'
      });
      log('batched', 'ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (íì— ì¶”ê°€ë¨)', { queueSize: RecommendSDK._queue.length });
    }

    // ìˆ˜ë™ ì œì–´
    function manualFlush() {
      const queueSize = RecommendSDK._queue.length;
      if (queueSize === 0) {
        log('system', 'íê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
        return;
      }
      RecommendSDK.flush();
      log('system', `ìˆ˜ë™ Flush: ${queueSize}ê°œ ì´ë²¤íŠ¸ ì „ì†¡ë¨`);
    }

    function checkQueue() {
      const queueSize = RecommendSDK._queue.length;
      log('system', `í˜„ì¬ í ìƒíƒœ: ${queueSize}ê°œ ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘`, {
        batchSize: RecommendSDK.config.batchSize,
        note: queueSize >= RecommendSDK.config.batchSize ? 'âš ï¸ batchSize ë„ë‹¬ ì‹œ ìë™ ì „ì†¡ë¨' : 'âœ… ì•„ì§ ì „ì†¡ ì•ˆ ë¨'
      });
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // í˜ì´ì§€ ì´ë™ ì‹œë®¬ë ˆì´ì…˜
    function simulateNavigation() {
      const queueBefore = RecommendSDK._queue.length;
      log('system', `ğŸ”„ í˜ì´ì§€ ì´ë™ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘`, { queueBefore });
      
      console.log('%c[DEBUG] Before pushState:', 'color: orange', {
        queueLength: RecommendSDK._queue.length,
        routeHooked: RecommendSDK._routeHooked,
        autoRouteTracking: RecommendSDK.config.autoRouteTracking
      });
      
      // file:// í™˜ê²½ì—ì„œëŠ” pushStateê°€ SecurityErrorë¥¼ ë‚¼ ìˆ˜ ìˆì–´ ìš°íšŒ ì²˜ë¦¬
      if (window.location && window.location.protocol === 'file:') {
        if (queueBefore > 0) RecommendSDK.flush();
        RecommendSDK.trackPageView(window.location.href + '#route=' + Date.now(), null, { immediate: true });
        log('system', 'file:// í™˜ê²½: pushState ëŒ€ì‹  flush + page_view ì¦‰ì‹œ ì „ì†¡', { queueBefore });
        return;
      }

      // http(s) í™˜ê²½ì—ì„œëŠ” history.pushState í˜¸ì¶œ â†’ SDKê°€ ìë™ìœ¼ë¡œ ê°ì§€
      window.history.pushState({}, '', '/new-page?t=' + Date.now());
      
      console.log('%c[DEBUG] After pushState:', 'color: green', {
        queueLength: RecommendSDK._queue.length
      });
      
      // SDKì˜ _hookRoutesê°€ ê°ì§€í•´ì„œ ìë™ ì²˜ë¦¬ (ë™ê¸°ì ìœ¼ë¡œ ì¦‰ì‹œ ì‹¤í–‰ë¨)
      setTimeout(() => {
        const queueAfter = RecommendSDK._queue.length;
        log('system', 'âœ… SDK ìë™ ì²˜ë¦¬ ê²°ê³¼', {
          queueBefore: `${queueBefore}ê°œ`,
          queueAfter: `${queueAfter}ê°œ`,
          expected: queueBefore > 0 ? 'íê°€ ë¹„ì›Œì¡Œì–´ì•¼ í•¨ (0ê°œ)' : 'ë³€í™” ì—†ìŒ',
          actual: queueAfter === 0 ? 'âœ… ì •ìƒ' : 'âŒ ë¬¸ì œ ë°œìƒ!'
        });
      }, 100);
    }

    // í˜ì´ì§€ ì´íƒˆ ì‹œ ìë™ ì „ì†¡ í…ŒìŠ¤íŠ¸ìš©
    window.addEventListener('beforeunload', function(e) {
      const queueSize = RecommendSDK._queue.length;
      if (queueSize > 0) {
        console.log(`[í˜ì´ì§€ ì´íƒˆ] ${queueSize}ê°œ ì´ë²¤íŠ¸ë¥¼ sendBeaconìœ¼ë¡œ ì „ì†¡`);
        // SDK ë‚´ë¶€ì—ì„œ ìë™ìœ¼ë¡œ flush({ useBeacon: true }) í˜¸ì¶œë¨
      }
    });
  </script>
</body>
</html>
