(()=>{var I="1.1.0";function v(){return new Date().toISOString()}function a(e,n){try{return e?e.getItem(n):null}catch(t){return null}}function r(e,n,t){try{if(!e)return;e.setItem(n,t)}catch(o){}}function f(e,n){try{if(!e)return;e.removeItem(n)}catch(t){}}var u={anonymousId:"recommend_sdk_anonymous_id",userId:"recommend_sdk_user_id",sessionId:"recommend_sdk_session_id",deviceId:"recommend_sdk_device_id",appInstanceId:"recommend_sdk_app_instance_id"};function c(e){try{if(typeof crypto!="undefined"&&crypto&&typeof crypto.randomUUID=="function")return`${e}_${crypto.randomUUID()}`}catch(n){}return`${e}_${Math.random().toString(36).slice(2)}_${Date.now()}`}function w(){try{if(typeof document=="undefined"||!document.cookie)return null;let e=document.cookie.match(/(?:^|;\s*)_ga=([^;]+)/);if(!e)return null;let t=decodeURIComponent(e[1]||"").split(".");return t.length>=4?`${t[2]}.${t[3]}`:null}catch(e){return null}}function y(e){return function(t,o,i){if(!e&&t!=="error")return;let s="[RecommendSDK]";try{i!==void 0?console[t](s,o,i):console[t](s,o)}catch(l){}}}function g(e){return String(e||"").replace(/\/$/,"")}var m={development:"https://dev-ba.redprinting.net",staging:"https://stg-ba.redprinting.net",production:"https://ba.redprinting.net"};function S(e){if(!e)return"";if(e.apiUrl)return g(e.apiUrl);let n=e.env||"production";return e.apiUrls&&e.apiUrls[n]?g(e.apiUrls[n]):m[n]?g(m[n]):""}var d={version:I,_initialized:!1,_log:y(!1),_flushTimer:null,_routeHooked:!1,_journey:[],_pageInstanceId:null,_queue:[],config:{env:"production",apiUrl:"",domainId:null,channel:"web",sdkVersion:I,appVersion:null,anonymousId:null,userId:null,sessionId:null,clientId:null,deviceId:null,appInstanceId:null,enableLogging:!1,emitIdentityEvents:!0,autoPageView:!0,autoRouteTracking:!0,flushOnRouteChange:!0,journeyMaxLen:100,batchSize:20,flushIntervalMs:1e4,enableAutoFlush:!1,immediateEventTypes:{action:!0,add_to_cart:!0,remove_from_cart:!0,purchase:!0,begin_checkout:!0,add_payment_info:!0,add_shipping_info:!0}},init(e){if(this._initialized){this._log("warn","already initialized");return}e=e||{};let n=S(e);if(!n)throw new Error("RecommendSDK: apiUrl (or apiUrls+env) is required");this.config.env=e.env||this.config.env,this.config.apiUrl=n,this.config.domainId=e.domainId||null,this.config.channel=e.channel||this.config.channel,this.config.sdkVersion=e.sdkVersion||this.config.sdkVersion,this.config.appVersion=e.appVersion||this.config.appVersion,this.config.enableLogging=!!e.enableLogging,this._log=y(this.config.enableLogging),typeof e.emitIdentityEvents=="boolean"&&(this.config.emitIdentityEvents=e.emitIdentityEvents),typeof e.autoPageView=="boolean"&&(this.config.autoPageView=e.autoPageView),typeof e.autoRouteTracking=="boolean"&&(this.config.autoRouteTracking=e.autoRouteTracking),typeof e.flushOnRouteChange=="boolean"&&(this.config.flushOnRouteChange=e.flushOnRouteChange),typeof e.journeyMaxLen=="number"&&(this.config.journeyMaxLen=e.journeyMaxLen),typeof e.batchSize=="number"&&(this.config.batchSize=e.batchSize),typeof e.flushIntervalMs=="number"&&(this.config.flushIntervalMs=e.flushIntervalMs),typeof e.enableAutoFlush=="boolean"&&(this.config.enableAutoFlush=e.enableAutoFlush),e.immediateEventTypes&&typeof e.immediateEventTypes=="object"&&(this.config.immediateEventTypes={...this.config.immediateEventTypes,...e.immediateEventTypes});let t=typeof localStorage!="undefined"?localStorage:null,o=typeof sessionStorage!="undefined"?sessionStorage:null,i=e.anonymousId||a(t,u.anonymousId);i||(i=c("anon")),r(t,u.anonymousId,i);let s=e.userId||a(t,u.userId)||null,l=e.sessionId||a(o,u.sessionId);l||(l=c("sess")),r(o,u.sessionId,l);let p=e.clientId||w()||null,h=e.deviceId||a(t,u.deviceId)||null;h||(h=c("dev"),r(t,u.deviceId,h)),this.config.anonymousId=i,this.config.userId=s,this.config.sessionId=l,this.config.clientId=p,this.config.deviceId=h,this.config.appInstanceId=e.appInstanceId||a(t,u.appInstanceId)||null,this.config.appInstanceId&&r(t,u.appInstanceId,this.config.appInstanceId),this._pageInstanceId=c("page"),this._initialized=!0,this._startFlushTimer(),this._setupLifecycleFlush(),this.config.autoRouteTracking&&this._hookRoutes(),this.config.autoPageView&&this.trackPageView(null,null,{immediate:!0}),this._log("info","initialized",{apiUrl:this.config.apiUrl,env:this.config.env,domainId:this.config.domainId,anonymousId:this.config.anonymousId,userId:this.config.userId,sessionId:this.config.sessionId})},identify(e,n){e=e||{},n=n||{};let t={userId:this.config.userId,anonymousId:this.config.anonymousId,sessionId:this.config.sessionId};e.userId!==void 0&&this.setUserId(e.userId),e.anonymousId!==void 0&&this.setAnonymousId(e.anonymousId),e.sessionId!==void 0&&this.setSessionId(e.sessionId),e.clientId!==void 0&&this.setClientId(e.clientId),e.deviceId!==void 0&&this.setDeviceId(e.deviceId),e.appInstanceId!==void 0&&this.setAppInstanceId(e.appInstanceId),(n.emitEvent!==void 0?!!n.emitEvent:!!this.config.emitIdentityEvents)&&this.trackEvent("identify",{prev:t,next:{userId:this.config.userId,anonymousId:this.config.anonymousId,sessionId:this.config.sessionId}},{immediate:!0,url:n.url})},setUserId(e){this.config.userId=e||null;let n=typeof localStorage!="undefined"?localStorage:null;e?r(n,u.userId,String(e)):f(n,u.userId)},setAnonymousId(e){this.config.anonymousId=e||null;let n=typeof localStorage!="undefined"?localStorage:null;e?r(n,u.anonymousId,String(e)):f(n,u.anonymousId)},setSessionId(e){this.config.sessionId=e||null;let n=typeof sessionStorage!="undefined"?sessionStorage:null;e?r(n,u.sessionId,String(e)):f(n,u.sessionId)},setClientId(e){this.config.clientId=e||null},setDeviceId(e){this.config.deviceId=e||null;let n=typeof localStorage!="undefined"?localStorage:null;e?r(n,u.deviceId,String(e)):f(n,u.deviceId)},setAppInstanceId(e){this.config.appInstanceId=e||null;let n=typeof localStorage!="undefined"?localStorage:null;e?r(n,u.appInstanceId,String(e)):f(n,u.appInstanceId)},logout(e){e=e||{};let n=e.resetSession!==!1,t=!!e.rotateAnonymousId;(e.emitEvent!==void 0?!!e.emitEvent:!!this.config.emitIdentityEvents)&&this.trackEvent("logout",{userId:this.config.userId,anonymousId:this.config.anonymousId,sessionId:this.config.sessionId},{immediate:!0,url:e.url}),this.setUserId(null),n&&(this.setSessionId(c("sess")),this._pageInstanceId=c("page")),t&&this.setAnonymousId(c("anon"))},_setupLifecycleFlush(){if(typeof window=="undefined")return;let e=this;function n(){try{e.flush({useBeacon:!0})}catch(t){}}window.addEventListener("pagehide",n),window.addEventListener("beforeunload",n),typeof document!="undefined"&&document.addEventListener("visibilitychange",function(){document.hidden&&n()})},_hookRoutes(){if(this._routeHooked||typeof window=="undefined"||!window.history)return;let e=this;function n(){e._log("info","route change detected",{queueSize:e._queue?e._queue.length:0}),e.config.flushOnRouteChange&&e._queue&&e._queue.length>0&&(e._log("info","flushing queue on route change",{count:e._queue.length}),e.flush()),e._pageInstanceId=c("page"),e.trackPageView(null,null,{immediate:!0})}let t=window.history.pushState,o=window.history.replaceState;typeof t=="function"&&(window.history.pushState=function(){let i=t.apply(this,arguments);try{n()}catch(s){}return i}),typeof o=="function"&&(window.history.replaceState=function(){let i=o.apply(this,arguments);try{n()}catch(s){}return i}),window.addEventListener("popstate",function(){try{n()}catch(i){}}),this._routeHooked=!0,this._log("info","route tracking hooked",{pushStateHooked:typeof window.history.pushState=="function",replaceStateHooked:typeof window.history.replaceState=="function"})},_startFlushTimer(){let e=this;e._flushTimer&&clearInterval(e._flushTimer),e.config.enableAutoFlush&&(e._flushTimer=setInterval(function(){e.flush()},e.config.flushIntervalMs))},_pushJourney(e){this._journey.push(e),this._journey.length>this.config.journeyMaxLen&&this._journey.splice(0,this._journey.length-this.config.journeyMaxLen)},_baseEvent(e,n,t){let o=null,i=null;try{o=typeof document!="undefined"&&document.referrer||null}catch(s){}try{i=typeof navigator!="undefined"&&navigator.userAgent||null}catch(s){}return{domainId:this.config.domainId,anonymousId:this.config.anonymousId,userId:this.config.userId,sessionId:this.config.sessionId,clientId:this.config.clientId,deviceId:this.config.deviceId,appInstanceId:this.config.appInstanceId,requestId:c("req"),pageInstanceId:this._pageInstanceId,canonicalPageKey:null,sdkVersion:this.config.sdkVersion,appVersion:this.config.appVersion,channel:this.config.channel,eventType:e,url:n,referrer:o,userAgent:i,payload:t||{},timestamp:v()}},_withJourney(e){let n=e||{};return n.journey=(this._journey||[]).slice(-this.config.journeyMaxLen),n},trackPageView(e,n,t){if(!this._initialized)throw new Error("RecommendSDK not initialized. Call init() first.");t=t||{};let o=e||(typeof window!="undefined"&&window.location?window.location.href:""),i=this._baseEvent("page_view",o,this._withJourney(n));if(this._pushJourney({ts:i.timestamp,eventType:i.eventType,url:i.url}),t.immediate)return this._sendOne(i);this._enqueue(i)},trackEvent(e,n,t){if(!this._initialized)throw new Error("RecommendSDK not initialized. Call init() first.");t=t||{};let o=t.url||(typeof window!="undefined"&&window.location?window.location.href:""),i=this._baseEvent(e||"event",o,this._withJourney(n));return this._pushJourney({ts:i.timestamp,eventType:i.eventType,url:i.url}),!!t.immediate||this.config.immediateEventTypes&&this.config.immediateEventTypes[i.eventType]?this._sendOne(i):(this._enqueue(i),null)},trackAction(e,n,t){t=t||{};let o=n||{};return o.actionName=e,this.trackEvent("action",o,{immediate:!0,url:t.url})},_enqueue(e){this._queue||(this._queue=[]),this._queue.push(e),this._queue.length>=this.config.batchSize&&this.flush()},flush(e){if(e=e||{},!this._queue||this._queue.length===0)return null;let n=this._queue.splice(0,this.config.batchSize);return this._sendBatch(n,e)},_sendOne(e){let n=`${this.config.apiUrl}/api/v1/events`;return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()}).catch(t=>{try{d._queue||(d._queue=[]),d._queue.unshift(e)}catch(o){}return d._log("error","sendOne failed",{error:String(t&&t.message?t.message:t)}),null})},_sendBatch(e,n){let t=`${this.config.apiUrl}/api/v1/events/batch`,o=JSON.stringify({events:e});if(n&&n.useBeacon&&typeof navigator!="undefined"&&navigator.sendBeacon)try{let i=new Blob([o],{type:"application/json"});if(!navigator.sendBeacon(t,i))throw new Error("sendBeacon returned false");return this._log("info","batch sent via beacon",{count:e.length}),null}catch(i){}return fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:o,keepalive:!0}).then(i=>{if(!i.ok)throw new Error(`HTTP ${i.status}`);return i.json()}).catch(i=>{try{d._queue||(d._queue=[]),d._queue.unshift(...e)}catch(s){}return d._log("error","sendBatch failed",{error:String(i&&i.message?i.message:i)}),null})},recommend(e){if(!this._initialized)throw new Error("RecommendSDK not initialized. Call init() first.");e=e||{};let n=`${this.config.apiUrl}/api/v1/recommend`,t=e.url||(typeof window!="undefined"&&window.location?window.location.href:""),o=e.context&&typeof e.context=="object"?e.context:{};o.url=o.url||t,o.referrer=o.referrer||typeof document!="undefined"&&document.referrer||null,o.journey=(this._journey||[]).slice(-this.config.journeyMaxLen);let i={domainId:e.domainId!==void 0?e.domainId:this.config.domainId,userId:e.userId!==void 0?e.userId:this.config.userId,anonymousId:e.anonymousId!==void 0?e.anonymousId:this.config.anonymousId,channel:e.channel||this.config.channel,clientId:e.clientId!==void 0?e.clientId:this.config.clientId,deviceId:e.deviceId!==void 0?e.deviceId:this.config.deviceId,appInstanceId:e.appInstanceId!==void 0?e.appInstanceId:this.config.appInstanceId,context:o};return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(s=>{if(!s.ok)throw new Error(`HTTP ${s.status}`);return s.json()}).catch(s=>(d._log("error","recommend failed",{error:String(s&&s.message?s.message:s)}),null))}};var _=d;if(typeof window!="undefined"){window.RecommendSDK=_;try{window.recommendSDKConfig&&window.RecommendSDK.init(window.recommendSDKConfig)}catch(e){}}})();
